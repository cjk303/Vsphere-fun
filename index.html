<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VM Snapshot Manager</title>

    <!-- Local Bootstrap CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<div class="container my-5">
    <h1 class="mb-4 text-epiq-primary">VM Snapshot Manager</h1>

    <!-- VM Input -->
    <div class="card mb-4 epiq-card">
        <div class="card-body">
            <h5 class="card-title text-epiq-accent">Paste VM Names or IPs</h5>
            <textarea id="hosts_input" class="form-control epiq-input" rows="8" placeholder="One VM per line"></textarea>
            <button id="parse_hosts_btn" class="btn epiq-btn mt-3">Parse Hosts</button>
        </div>
    </div>

    <!-- VM Table -->
    <div id="hosts_table_div" class="mb-4"></div>

    <!-- Snapshot Settings (hidden until list is parsed) -->
    <div id="snapshot_controls" class="card mb-4 epiq-card" style="display:none;">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="snapshot_name" class="form-label text-epiq-accent">Snapshot Name</label>
                    <input type="text" id="snapshot_name" class="form-control epiq-input" value="AutoSnapshot">
                </div>
                <div class="col-md-6">
                    <label for="snapshot_desc" class="form-label text-epiq-accent">Snapshot Description</label>
                    <input type="text" id="snapshot_desc" class="form-control epiq-input" value="Created via web UI">
                </div>
            </div>
            <button id="snapshot_btn" class="btn epiq-btn mt-3">Start Snapshot</button>
        </div>
    </div>

    <!-- Snapshot Results -->
    <div id="results_div" class="mb-5"></div>
</div>

<!-- Local JS -->
<script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>

<script>
let hosts_list = [];
const socket = io();

// Debug connection
socket.on('connect', () => console.log("[DEBUG] Socket connected:", socket.id));
socket.on('disconnect', reason => console.warn("[DEBUG] Disconnected:", reason));

function renderTable(hosts) {
    let html = '<table class="table table-striped table-hover epiq-table">';
    html += '<thead><tr><th><input type="checkbox" id="select_all" checked></th><th>VM</th><th>Status</th><th>Progress</th></tr></thead><tbody>';
    hosts.forEach((host, index) => {
        html += `<tr>
            <td><input type="checkbox" class="select_host" data-index="${index}" checked></td>
            <td>${host.name}</td>
            <td id="status_${index}">Pending</td>
            <td>
                <div class="progress">
                    <div id="progress_${index}" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
            </td>
        </tr>`;
    });
    html += '</tbody></table>';
    $('#hosts_table_div').html(html);

    // Show snapshot controls once hosts are parsed
    $('#snapshot_controls').show();

    // Select all toggle
    $('#select_all').on('change', function(){
        $('.select_host').prop('checked', $(this).prop('checked'));
    });
}

$(document).ready(function(){
    // Parse hosts input
    $('#parse_hosts_btn').click(function(){
        let data = $('#hosts_input').val().split('\n').filter(x => x.trim() !== '');
        hosts_list = data.map(name => ({name: name.trim(), selected: true}));
        console.log("[DEBUG] Parsed hosts:", hosts_list);
        renderTable(hosts_list);
    });

    // Start snapshots
    $('#snapshot_btn').click(function(){
        $(this).prop("disabled", true).text("Starting...");
        hosts_list.forEach((h, i) => h.selected = $(`.select_host[data-index=${i}]`).prop('checked'));
        socket.emit('start_snapshots', {
            hosts: hosts_list,
            snapshot_name: $('#snapshot_name').val(),
            snapshot_desc: $('#snapshot_desc').val()
        });
    });

    // Progress updates
    socket.on('snapshot_progress', function(data){
        console.log("[DEBUG] snapshot_progress:", data);
        let index = hosts_list.findIndex(
            h => h.name.trim().toLowerCase() === data.host.trim().toLowerCase()
        );
        if(index >= 0){
            $('#status_' + index).text(data.message);
            let bar = $('#progress_' + index);
            if(data.progress > 0){
                bar.css('width', data.progress + '%')
                   .attr('aria-valuenow', data.progress)
                   .addClass('bg-epiq-progress');
            }
        } else {
            console.warn("[DEBUG] Could not match host for progress event:", data.host);
        }
    });

    // Completion updates
    socket.on('snapshot_complete', function(data){
        console.log("[DEBUG] snapshot_complete:", data);
        let index = hosts_list.findIndex(
            h => h.name.trim().toLowerCase() === data.host.trim().toLowerCase()
        );
        if(index >= 0){
            $('#status_' + index).text('Completed').removeClass().addClass('text-success');
            $('#progress_' + index).css('width', '100%')
                .addClass('bg-success')
                .attr('aria-valuenow', 100);
            $('#snapshot_btn').prop("disabled", false).text("Start Snapshot");
        } else {
            console.warn("[DEBUG] Could not match host for complete event:", data.host);
        }
    });
});
</script>
</body>
</html>
